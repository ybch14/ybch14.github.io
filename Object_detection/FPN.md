# Feature Pyramid Network

特征金字塔网络，目的是利用卷积网络中不同尺度的特征图，因为不同尺度的特征图包含不同的语义含义。网络的目的是为了构建带有高层语义含义的特征金字塔。

### 1. FPN

- FPN 的输入为任意大小的图片，输出大小成比例的不同层级的特征图。
- 构建特征图的过程与提取特征的 backbone 卷积网络独立。论文总采用的卷积网络是 ResNet。
- 网络的结构包含如下几个部分：
  - 自底向上的通路：卷积网络（backbone）的前向计算通路。计算得到层次结构的特征图，每层之间尺度的缩放系数为2。在网络中有很多连续的特征图尺寸相同，把这些连续的特征图称为一段（stage）。对于特征金字塔中的特征图，每一段被定义为一级。我们选择每一段的最后一层特征图作为特征金字塔的参考特征图，因为在一级中最深层的特征图通常具有最代表性的特征。对于 ResNet 来说，选择每段的最后一个 residual block 的输出作为特征图。把 ResNet 中每个阶段的输出记作 $\{C_2, C_3, C_4, C_5\}$，这些特征图相对原图来说跨距为 {4, 8, 16, 32} 。
  - 自顶向下的通路：在自顶向下的通路中，下一层的特征图是从上一层特征图进行升采样得到的。除了升采样之外，在自顶向下的通路和自底向上的通路中还存在横向连接：每个横向连接把两个通路中相同大小的特征图融合在一起（自底向上特征图 --> 1x1 conv + 2倍升采样{上层的自顶向下特征图}）。虽然自底向上的特征图特征含义比较弱，但是其经过升采样的次数比较少，位置更精确。自顶向下通路的生成过程是一个迭代过程：在自顶向下的通路中最高层级（尺寸最小）的特征图是从自底向上通路中最小的特征图经过 1x1 的卷积层之后得到的；之后按上面的方法迭代逐层构建通路，直至得到的特征图和自底向上通路中最大的特征图制度相同为止。迭代结束之后自顶向下通路中所有的特征图再经过一个 3x3 的卷积层，用于消除升采样的混叠效应。最终得到的自顶向下通路中的特征图记作 $\{P_2, P_3, P_4, P_5\}$。
  - 网络在自顶向下通路中的每一级都会有预测输出（分类标签/box  regression 输出）。由于分类器和回归器的参数都是共享的，所以自顶向下通路中每一层的特征图都应该具有相同的通道数。论文中取 256 个通路。在自顶向下通路中所有的层都不引入非线性激活函数。
  - 文章中提到，这篇文章的目的是提出一种带有横向连接的特征金字塔的结构。至于横向连接的具体形式不做深究。实际上采用一个 residual block 代替上文提到的 1x1 卷积层会有更好的结果，但是不属于这篇文章的讨论范围。

### 2. FPN 的应用

- FPN for RPN (Region Proposal Network)
  - RPN 是一个在卷积网络最后一层特征图上滑动的小网络，包含一个 3x3 的卷积层和两个 1x1 的卷积层，称为 *head*。​其分类标准和 bounding box 回归的都是建立在 anchor 的概念之上（见 Faster R-CNN）。
  - 在 RPN 中使用 FPN 的方法很简单，就是用特征金字塔结构代替卷积网络最后一层的特征图。将head 网络（3x3 卷积和 2 个 1x1 卷积）应用到特征金字塔自顶向下通路的所有特征图中。由于 head
   网络在所有（不同尺度的）特征图上的所有位置上滑动，所以没有必要对每一个特征图都选择多个尺度的 anchor，在一层中使用一个尺度的 anchor 就可以。论文中的做法是在 $\{P_2, P_3, P_4, P_5, P_6\}$ 上分别使用 $\{32^2, 64^2, 128^2, 256^2, 512^2\}$ 大小的 anchor（$P_6$ 是 $P_5$ 的简单 2 倍下采样，仅仅为了引入 $512^2$ 的 anchor，不在 Fast R-CNN 中使用）。长宽比还是和 Faster R-CNN 中一样，为 $\{1:2, 1:1, 2:1\}$。对整个特征金字塔，一共有 15 种不同的 anchor。
  - 